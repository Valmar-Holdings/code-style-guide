<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <base href="https://valmar-holdings.github.io/code-style-guide/">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="Beautiful docs powered by Jigsaw">

        <meta property="og:site_name" content="Docs Starter Template"/>
        <meta property="og:title" content="Models | Docs Starter Template"/>
        <meta property="og:description" content="Beautiful docs powered by Jigsaw"/>
        <meta property="og:url" content="https://valmar-holdings.github.io/code-style-guide/docs/laravel/models"/>
        <meta property="og:image" content="/assets/img/logo.png"/>
        <meta property="og:type" content="website"/>

        <meta name="twitter:image:alt" content="Docs Starter Template">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="generator" content="tighten_jigsaw_doc">

        <title>Docs Starter Template | Models</title>

        <link rel="home" href="https://valmar-holdings.github.io/code-style-guide/">
        <link rel="icon" href="https://valmar-holdings.github.io/code-style-guide/favicon.ico">

        
                    <!-- Insert analytics code here -->
        
        <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,300i,400,400i,700,700i,800,800i" rel="stylesheet">
        <link rel="stylesheet" href="https://valmar-holdings.github.io/code-style-guide/assets/build/css/main.css?id=5d8ca266e3452f0b0849d26558057a38">
        <script defer src="https://valmar-holdings.github.io/code-style-guide/assets/build/js/main.js?id=6bee6b594711aaf71f3b28701cea7bf2"></script>
    </head>

    <body class="flex flex-col justify-between min-h-screen font-sans leading-normal text-gray-800 bg-gray-100">
        <header class="flex items-center h-24 py-4 mb-8 bg-white border-b shadow" role="banner">
            <div class="container flex items-center px-4 mx-auto max-w-8xl lg:px-8">
                <div class="flex items-center">
                    <a href="https://valmar-holdings.github.io/code-style-guide/" title="Docs Starter Template home" class="inline-flex items-center">
                        <img class="h-8 mr-3 md:h-10" src="https://valmar-holdings.github.io/code-style-guide/assets/img/logo.svg" alt="Docs Starter Template logo" />

                        <h1 class="pr-4 my-0 text-lg font-semibold text-blue-900 md:text-2xl hover:text-blue-600">Docs Starter Template</h1>
                    </a>
                </div>

                <div class="flex items-center justify-end flex-1 text-right md:pl-10">

                    <div>


<div x-data="search()" class="mb-4 space-y-2 md:mb-8 lg:mb-10 xl:mb-12">
  <input
    type="search"
    name="search"
    placeholder="Search &mldr;"
    autocomplete="off"
    @input.debounce.250ms="search()"
    class="w-full px-4 py-2 bg-white border-b-2 shadow dark:bg-night-10 border-night-10 dark:border-snow-10 rounded-1 focus:outline-none focus:border-brand"
  />
<ol class="space-y-2 list-none"
>
    <template x-for="result in results">
      <li
        class="p-4 overflow-hidden bg-white shadow rounded-1 dark:bg-night-20"
      >
        <a :href="result.url" class="block group">
          <div class="flex justify-between space-x-2 sm:justify-start">
            <strong
              x-text="result.title"
              class="group-hover:text-brand"
            ></strong>
            <span class="text-snow-20 dark:text-snow-10">
              
              <time x-text="result.date"></time>
            </span>
          </div>
          <p class="truncate" x-text="result.description"></p>
        </a>
      </li>
    </template>
  </ol>
</div>
  <script>
    function search()
    {
        return {
    items: [],
    fuse: null,
    query: "",
    results: [],

    init: function () {
        let url = new URL(window.location);
        url.pathname = "index.json";
        url.searchParams.set("t", Date.now());

        fetch(url.toString())
            .then((response) => response.json())
            .then((items) => {
                this.items = items;

                this.fuse = new Fuse(items, {
                    findAllMatches: true,
                    includeScore: true,
                    keys: ["content"],
                    minMatchCharLength: 3,
                    threshold: 0.9,
                });
        console.log(this.fuse.search("test"));
            })
            .catch(console.error);
    },

    search: function () {
        if (this.fuse === null) {
            this.results = [];

            return false;
        }

        this.results = this.fuse.search(this.query);
            

            console.log(this.results);
    },
};
    }
  </script>
</div>

                </div>
            </div>

                <button class="flex justify-center items-center bg-blue-500 border border-blue-500 h-10 mr-4 px-5 rounded-full lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>


        </header>

        <main role="main" class="flex-auto w-full">

            <section class="container px-6 py-4 mx-auto max-w-8xl md:px-8">
    <div class="flex flex-col lg:flex-row">
        <nav id="js-nav-menu" class="hidden nav-menu lg:block">
            <ul class="my-0">
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/overview"
            class="lvl0   nav-menu__item hover:text-blue-500"
        >
            Overview
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel"
            class="lvl0 lvl0-active  nav-menu__item hover:text-blue-500"
        >
            Laravel
        </a>
    
            
        <ul class="my-0">
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/eloquent"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Eloquent
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/livewire"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Livewire
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/blade"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Blade
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/seeders"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Seeders
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/migrations"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Migrations
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/controllers"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Controllers
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/classes"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Classes
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/npm"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            NPM
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/models"
            class="lvl1  active font-semibold text-blue-500 nav-menu__item hover:text-blue-500"
        >
            Models
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/routes"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Routes
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/tests"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Tests
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/config-env"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Config &amp; Environment
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/patterns"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Patterns
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/code-cleanliness"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Code Cleanliness
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/conventions"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Conventions
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/type-hinting"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Type Hinting &amp; Return Types
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/exceptions"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Exceptions
        </a>
    
    </li>
            <li class="pl-4">
            
        <a href="https://valmar-holdings.github.io/code-style-guide/docs/laravel/null"
            class="lvl1   nav-menu__item hover:text-blue-500"
        >
            Null &amp; Null Objects
        </a>
    
    </li>
    </ul>
    </li>
    </ul>
        </nav>

        <div class="w-full pb-16 break-words DocSearch-content lg:w-3/5 lg:pl-4" v-pre>
            <h3>Eager Loading</h3>

<ul>
<li>Avoid eager loading relationships in the <code>protected $with = [];</code> variable.</li>
<li>Try to explicitly load relationships at the point they are used.</li>
</ul>

<h3>Organization</h3>

<ol>
<li>List <code>use</code> classes.</li>
<li>List the public, protected, and private properties, each group in alphabetical order.</li>
<li>List relationship methods.</li>
<li>List getter and setter methods.</li>
<li>List persistence methods.</li>
<li>List protected methods.</li>
<li>List private methods.</li>
</ol>

<p>Persistence Methods</p>

<ul>
<li>Laravel models are the de-facto persistence repository, especially in eloquent.</li>
<li>Do not use the generic eloquent CRUD methods <code>save()</code>, <code>update()</code>, <code>create()</code>, <code>delete()</code>, etc. outside of the model. Instead create descriptive methods that explain exactly what is happening. This decouples the business domain from the persistence domain of the app, as well as makes code so much more humanly readable. For instance: instead of <code>$user-&gt;save()</code> create a method that handles a specific situation, like <code>$agent-&gt;addListingInfo($listingInfo);</code> and then handle all the data parsing and assignment in the method, at the end of which <code>$this-&gt;save()</code> is called to persist the changes.</li>
</ul>

<p>This pattern is not a Repository pattern, but instead an adaptation thereof for Laravel models. Laravel models already implement the repository patter in how they are build on top of Eloquent, so splitting out each model into multiple single-use-traits is an effort to maintain organization, while the other rules enforce the repository pattern of the model throughout the code-base.</p>

<p>The benefits of this guide go deep beneath the surface, and at first glance may not be apparent:</p>

<ul>
<li>centralized place of maintenance in the attribute and query traits.</li>
<li>deep performance optimization via centralized caching in the traits. This automatically ensures that relationship references are cached as well, for example when looping over a relationship collection.</li>
<li>reduced technical dept, as queries and custom attributes are all contained in known centralized traits. This makes maintenance much easier when fixing or optimizing queries, as it is no longer necessary to inspect your entire codebase.</li>
<li>reduced visual dept in models, as the custom parts are separated out into traits, keeping the model itself lean and to the point.</li>
<li>adoption of better patterns: separating and centralizing queries helps DRY up your code, as well as force you to think more about how each query works and discover areas it can be optimized, by pulling it out of context, and looking at it on its own, without being distracted by the domain logic surrounding it.</li>
</ul>

<h2>Structure</h2>

<ul>
<li>Model class should only contain properties and relationship methods.</li>
<li>All attribute methods should be extracted to an Attributes trait.</li>
<li>All query methods should be extracted to traits:</li>
</ul>

<pre><code class="language-txt">App
 |-Traits
 | |-Attributes
 | | \-Book
 | |
 | \-Queries
 |   \-Book
 |
 |-BaseModel
 \-Book
 ```

 ```php
&lt;?php namespace App;

use Illuminate\Cache\TaggableStore;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Collection;
use Illuminate\View\View;
use Laravel\Scout\Searchable;

abstract class BaseModel extends Model
{
    use Searchable;

    public static function boot()
    {
        parent::boot();

        static::created(function () {
            self::flushCache();
        });

        static::deleted(function () {
            self::flushCache();
        });

        static::saved(function () {
            self::flushCache();
        });

        static::updated(function () {
            self::flushCache();
        });
    }

    public function cache(array $additionalTags = []) : View
    {
        if (cache()-&gt;getStore() instanceof TaggableStore) {
            $tags = array_push($additionalTags, str_slug(self::class));
            $cache = $cache-&gt;tags($tags);
        }

        return $cache;
    }

    public static function flushCache()
    {
        cache()-&gt;tags([str_slug(self::class)])
            -&gt;flush();
    }
}
</code></pre>

<pre><code class="language-php">&lt;?php namespace App;

use App\Traits\Attributes\Contact as Attributes;
use App\Traits\Queries\Contact as Queries;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;

class Contact extends BaseModel
{
    use Attributes;
    use Queries;

    protected $appends = [
        'searchKey',
        'searchUrl',
    ];
    protected $fillable = [
        'name',
        'title',
        'work_phone',
        'mobile_phone',
        'work_email',
        'private_email',
    ];

    public function contactTypes() : BelongsToMany
    {
        return $this-&gt;belongsToMany(ContactType::class);
    }
}
</code></pre>

<pre><code class="language-php">&lt;?php namespace App\Traits\Attributes;

trait Contact
{
    public function getGravatarAttribute() : string
    {
        $defaultAvatar = 'https://www.gravatar.com/avatar/?d=mm';
        $workAvatar = 'https://www.gravatar.com/avatar/' . md5(strtolower(trim($this-&gt;work_email))) . '?d=mm';
        $privateAvatar = 'https://www.gravatar.com/avatar/' . md5(strtolower(trim($this-&gt;private_email))) . '?d=mm';

        if (md5(file_get_contents($workAvatar)) !== md5(file_get_contents($defaultAvatar))) {
            return $workAvatar;
        }

        if (md5(file_get_contents($privateAvatar)) !== md5(file_get_contents($defaultAvatar))) {
            return $privateAvatar;
        }

        return $defaultAvatar;
    }

    public function getSearchKeyAttribute() : string
    {
        return $this-&gt;name;
    }

    public function getSearchUrlAttribute() : string
    {
        return route('contacts.show', $this-&gt;getKey());
    }
}
&lt;?php namespace App\Traits\Queries;

use Illuminate\Support\Collection;

trait Contact
{
    public function getAll() : Collection
    {
        return cache()-&gt;tags([$this-&gt;classSlug])
            -&gt;rememberForever("contact-{$this-&gt;id}-getAll", function () {
                return $this-&gt;orderBy('name')-&gt;get();
            });
    }

    public function getByTypes(array $types) : Collection
    {
        $key = implode('-', $types);

        return cache()-&gt;tags([$this-&gt;classSlug, 'contact-type'])
            -&gt;rememberForever("contact-{$this-&gt;id}-getByTypes-{$key}", function () use ($types) {
                return $this-&gt;with(['contactTypes' =&gt; function ($query) use ($types) {
                        $query-&gt;whereIn('title', $types);
                    }])
                    -&gt;orderBy('name')
                    -&gt;get();
            });
    }
}
</code></pre>

<h2>Eloquent Queries</h2>

<p>All Eloquent queries should be processed in dedicated methods within the queries trait of the model. The default getter methods provided by Eloquent should not be used anywhere outside of the model or its traits, with the exception of the following:</p>

<ul>
<li>find()</li>
<li>findOrFail()</li>
</ul>

<h2>Relationship Properties</h2>

<p>Do not query relationship properties on models directly. Instead expose the relationship property as a dynamic property in the model itself. This allows you to provide a default if the relationship does not exist, as well as limits interdependence of models to only the models themselves, and not through your code. For example, instead of <code>$book-&gt;author-&gt;name</code>, create a model attribute called <code>authorName</code>, then call that as <code>$book-&gt;authorName</code> in your code:</p>

<pre><code class="language-php">&lt;?php namespace App;

use App\Traits\Attributes\Book as Attributes;

class Book extends Model
{
    use Attributes;

    public function author() : HasOne
    {
        return $this-&gt;hasOne(Author::class);
    }
}
&lt;?php namespace App\Traits\Attributes;

trait Book
{
    public function getAuthorNameAttribute() : string
    {
        return $this-&gt;author-&gt;name ?? '';
    }
}
</code></pre>

<h2>Naming Conventions</h2>

<h3>For Properties or Methods with Certain Return Types</h3>

<ul>
<li>boolean props or methods that check if a certain condition is true should be named <code>has&lt;Condition in past tense&gt;</code>.</li>
</ul>

<h3>For Query Methods</h3>

<ul>
<li>methods returning a single instance should be prefixed with <code>find</code> followed by the name of the model instance it returns, for example <code>-&gt;findUserByName(string $name)</code>.</li>
<li>methods returning a collection of instances should be prefixed with <code>get</code> followed by the name of the model instances is returns, for example <code>-&gt;getUsersByType(string $type)</code>.</li>
</ul>

<h2>Caching</h2>

<ul>
<li>Caching should only be done using tags named after the model, and any specific parameters that make that query unique. Cache tags should be flushed when the corresponding model gets updated, saved, or deleted, so that subsequent responses will incorporate the changes.</li>
<li>All queries in the model&#39;s query trait should be cached, as well those in attribute methods that access the database directly, and not through an already cached model query.</li>
<li>Cached queries should be cached forever by default. However, if they incorporate timestamps or other temporal conditions, a sensible timeout should be set, depending on their use-case, typically between 1 and 15 minutes.</li>
</ul>
        </div>
    </div>
</section>

        </main>


        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>

        <footer class="py-4 mt-12 text-sm text-center bg-white" role="contentinfo">
            <ul class="flex flex-col justify-center md:flex-row">
                <li class="md:mr-2">
                    &copy; <a href="https://tighten.co" title="Tighten website">Tighten</a> 2022.
                </li>

                <li>
                    Built with <a href="http://jigsaw.tighten.co" title="Jigsaw by Tighten">Jigsaw</a>
                    and <a href="https://tailwindcss.com" title="Tailwind CSS, a utility-first CSS framework">Tailwind CSS</a>.
                </li>
            </ul>
        </footer>
    </body>
</html>
